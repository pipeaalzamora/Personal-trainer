"use strict";(()=>{var e={};e.id=713,e.ids=[713],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},91297:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>A,patchFetch:()=>v,requestAsyncStorage:()=>E,routeModule:()=>h,serverHooks:()=>I,staticGenerationAsyncStorage:()=>f});var o={};t.r(o),t.d(o,{POST:()=>g});var s=t(49303),a=t(88716),n=t(60670),i=t(87070),p=t(8993),c=t(16506),u=t(62292),d=t(85662),l=t(36119);let m=new p.Z(u.v.commerceCode,u.v.apiKey,u.v.environment),x=new c.Z.Transaction(m);async function g(e){try{let r=(await e.formData()).get("token_ws");if(!r)return i.NextResponse.json({error:"Token no encontrado"},{status:400});let t=await x.commit(r),o=0===t.response_code,{data:s,error:a}=await d.OQ.from("orders").select("*").eq("transaction_token",r).single();if(a||!s)return i.NextResponse.json({error:`Orden no encontrada: ${a?.message||""}`},{status:404});let{error:n}=await d.OQ.from("orders").update({status:o?"COMPLETED":"FAILED",transaction_response:t}).eq("id",s.id);if(n)return i.NextResponse.json({error:`Error al actualizar la orden: ${n.message}`},{status:500});if(!o)return i.NextResponse.redirect(new URL(`/payment/error?code=${t.response_code}`,e.nextUrl.origin));{let{data:r}=await d.OQ.from("users").select("*").eq("id",s.user_id).single(),{data:t}=await d.OQ.from("order_items").select("course_id").eq("order_id",s.id);if(r&&t&&t.length>0){let e=t.map(e=>e.course_id),{data:o}=await d.OQ.from("courses").select("title").in("id",e),a=o?o.map(e=>e.title):[];await (0,l.bn)(r.email,{orderId:s.id,buyOrder:s.buy_order,courseTitles:a,totalAmount:s.total_amount})}return i.NextResponse.redirect(new URL(`/payment/success?order_id=${s.id}`,e.nextUrl.origin))}}catch(t){console.error("Error procesando el pago:",t);let r=t instanceof Error?t.message:"Error desconocido";return i.NextResponse.redirect(new URL(`/payment/error?message=${encodeURIComponent(r)}`,e.nextUrl.origin))}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/transbank/commit/route",pathname:"/api/transbank/commit",filename:"route",bundlePath:"app/api/transbank/commit/route"},resolvedPagePath:"/home/pipeaalzamora/Documentos/Personal-trainer/app/api/transbank/commit/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:E,staticGenerationAsyncStorage:f,serverHooks:I}=h,A="/api/transbank/commit/route";function v(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:f})}},62292:(e,r,t)=>{t.d(r,{v:()=>a});var o=t(16636);t.n(o)().config();let s="Production"===process.env.TRANSBANK_ENVIRONMENT,a={commerceCode:s?process.env.TRANSBANK_COMMERCE_CODE||"":process.env.TRANSBANK_COMMERCE_CODE||"597055555532",apiKey:s?process.env.TRANSBANK_API_KEY||"":process.env.TRANSBANK_API_KEY||"579B532A7440BB0C9079DED94D31EA1615BACEB56610332264630D42D0A36B1C",environment:s?"Production":"Integration",webpayHost:s?"https://webpay3g.transbank.cl":"https://webpay3gint.transbank.cl"}},36119:(e,r,t)=>{t.d(r,{Cz:()=>n,bn:()=>a});var o=t(55245);let s={host:process.env.EMAIL_SERVER||"",port:parseInt(process.env.EMAIL_PORT||"587"),secure:465===parseInt(process.env.EMAIL_PORT||"587"),auth:{user:process.env.EMAIL_USER||"",pass:process.env.EMAIL_PASSWORD||""}},a=async(e,r)=>{let{orderId:t,buyOrder:o,courseTitles:s,totalAmount:a}=r,i=s.map(e=>`<li>${e}</li>`).join("");return n({to:e,subject:"Confirmaci\xf3n de compra - Coach Inostroza",html:`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h2 style="color: #333;">\xa1Gracias por tu compra!</h2>
      <p>Tu pago ha sido procesado correctamente. A continuaci\xf3n, encontrar\xe1s los detalles de tu compra:</p>
      
      <div style="background-color: #f4f4f4; padding: 15px; border-radius: 4px; margin: 20px 0;">
        <p><strong>N\xfamero de orden:</strong> ${t}</p>
        <p><strong>Referencia de pago:</strong> ${o}</p>
        <p><strong>Monto total:</strong> $${a.toFixed(2)}</p>
      </div>
      
      <h3 style="color: #333;">Cursos adquiridos:</h3>
      <ul>
        ${i}
      </ul>
      
      <p>Puedes acceder a tus cursos iniciando sesi\xf3n en nuestra plataforma.</p>
      
      <p>Si tienes alguna consulta, no dudes en contactarnos.</p>
      
      <p>Saludos,<br>El equipo de Coach Inostroza</p>
    </div>
  `})},n=async e=>{let r=o.createTransport(s);try{let t=await r.sendMail({from:process.env.EMAIL_FROM||'"Coach Inostroza" <no-reply@coachinostroza.com>',...e});return console.log(`Email sent: ${t.messageId}`),!0}catch(e){return console.error("Error sending email:",e),!1}}},85662:(e,r,t)=>{t.d(r,{OQ:()=>n,_I:()=>i});var o=t(31518);let s="https://uhdgxofdtybgcfjnahkp.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZGd4b2ZkdHliZ2Nmam5haGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NzAyNjgsImV4cCI6MjA2MTQ0NjI2OH0.PgHnXDp1l7YB5zK7IEjSSEOM1yBjkvuEEDhUPHVTzM0";if(!s||!a)throw Error("Faltan las variables de entorno de Supabase. Aseg\xfarate de que NEXT_PUBLIC_SUPABASE_URL y NEXT_PUBLIC_SUPABASE_ANON_KEY est\xe9n definidas.");let n=(0,o.eI)(s,a,{auth:{persistSession:!0,autoRefreshToken:!0},global:{fetch:(...e)=>fetch(...e)}});async function i(e,r){let{error:t}=await n.storage.from(e).remove([r]);if(t)throw console.error("Error al eliminar archivo:",t),t;return!0}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[948,972,518,545,245],()=>t(91297));module.exports=o})();