"use strict";(()=>{var e={};e.id=118,e.ids=[118],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},86275:(e,r,o)=>{o.r(r),o.d(r,{originalPathname:()=>R,patchFetch:()=>S,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>N,staticGenerationAsyncStorage:()=>_});var t={};o.r(t),o.d(t,{POST:()=>b});var a=o(49303),s=o(88716),n=o(60670),i=o(87070),c=o(8993),p=o(16506),u=o(62292),l=o(84770);let d={randomUUID:l.randomUUID},m=new Uint8Array(256),f=m.length,h=[];for(let e=0;e<256;++e)h.push((e+256).toString(16).slice(1));let E=function(e,r,o){if(d.randomUUID&&!r&&!e)return d.randomUUID();let t=(e=e||{}).random??e.rng?.()??(f>m.length-16&&((0,l.randomFillSync)(m),f=0),m.slice(f,f+=16));if(t.length<16)throw Error("Random bytes length must be >= 16");if(t[6]=15&t[6]|64,t[8]=63&t[8]|128,r){if((o=o||0)<0||o+16>r.length)throw RangeError(`UUID byte range ${o}:${o+15} is out of buffer bounds`);for(let e=0;e<16;++e)r[o+e]=t[e];return r}return function(e,r=0){return(h[e[r+0]]+h[e[r+1]]+h[e[r+2]]+h[e[r+3]]+"-"+h[e[r+4]]+h[e[r+5]]+"-"+h[e[r+6]]+h[e[r+7]]+"-"+h[e[r+8]]+h[e[r+9]]+"-"+h[e[r+10]]+h[e[r+11]]+h[e[r+12]]+h[e[r+13]]+h[e[r+14]]+h[e[r+15]]).toLowerCase()}(t)};var g=o(85662),v=o(36119);let x="https://personal-trainer-roan.vercel.app/",I=new c.Z(u.v.commerceCode,u.v.apiKey,u.v.environment),A=new p.Z.Transaction(I);async function b(e){try{let{amount:r,email:o,cart:t}=await e.json();if(!r||r<=0)return i.NextResponse.json({error:"El monto debe ser mayor a 0"},{status:400});if(!o)return i.NextResponse.json({error:"El email es requerido"},{status:400});if(!t||!Array.isArray(t)||0===t.length)return i.NextResponse.json({error:"El carrito no puede estar vac\xedo"},{status:400});let a=`OC-${Date.now()}-${Math.floor(1e3*Math.random())}`,s=`SESSION-${o.split("@")[0]}-${Date.now()}`,{data:n,error:c}=await g.OQ.from("users").select("*").eq("email",o).single();if(c&&"PGRST116"!==c.code)throw Error(`Error al buscar usuario: ${c.message}`);let p=n;if(!p){let e=E(),{data:r,error:t}=await g.OQ.from("users").insert([{email:o,verified:!1,verification_token:e}]).select().single();if(t)throw Error(`Error al crear usuario: ${t.message}`);p=r,await (0,v.Cz)({to:o,subject:"Verifica tu correo electr\xf3nico - Coach Inostroza",html:`
          <p>Por favor, verifica tu correo electr\xf3nico haciendo clic en el siguiente enlace:</p>
          <a href="${x}/verify-email?token=${e}">Verificar correo</a>
        `})}if(!p)throw Error("No se pudo crear o encontrar el usuario");let{data:u,error:l}=await g.OQ.from("orders").insert([{user_id:p.id,total_amount:r,buy_order:a,session_id:s,status:"PENDING"}]).select().single();if(l||!u)throw Error(`Error al crear la orden: ${l?.message||"Datos de orden no disponibles"}`);let d=t.map(e=>({order_id:u.id,course_id:e.id,price:e.price})),{error:m}=await g.OQ.from("order_items").insert(d);if(m)throw Error(`Error al crear los items de la orden: ${m.message}`);let f=new URL("/api/transbank/commit",x).toString(),h=await A.create(a,s,r,f),{error:I}=await g.OQ.from("orders").update({transaction_token:h.token}).eq("id",u.id);if(I)throw Error(`Error al actualizar la orden: ${I.message}`);return i.NextResponse.json(h)}catch(r){console.error("Error creando transacci\xf3n:",r);let e=r instanceof Error?r.message:"Error al crear la transacci\xf3n";return i.NextResponse.json({error:e},{status:500})}}let y=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/transbank/create/route",pathname:"/api/transbank/create",filename:"route",bundlePath:"app/api/transbank/create/route"},resolvedPagePath:"/home/pipeaalzamora/Documentos/Personal-trainer/app/api/transbank/create/route.ts",nextConfigOutput:"standalone",userland:t}),{requestAsyncStorage:w,staticGenerationAsyncStorage:_,serverHooks:N}=y,R="/api/transbank/create/route";function S(){return(0,n.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:_})}},62292:(e,r,o)=>{o.d(r,{v:()=>s});var t=o(16636);o.n(t)().config();let a="Production"===process.env.TRANSBANK_ENVIRONMENT,s={commerceCode:a?process.env.TRANSBANK_COMMERCE_CODE||"":process.env.TRANSBANK_COMMERCE_CODE||"597055555532",apiKey:a?process.env.TRANSBANK_API_KEY||"":process.env.TRANSBANK_API_KEY||"579B532A7440BB0C9079DED94D31EA1615BACEB56610332264630D42D0A36B1C",environment:a?"Production":"Integration",webpayHost:a?"https://webpay3g.transbank.cl":"https://webpay3gint.transbank.cl"}},36119:(e,r,o)=>{o.d(r,{Cz:()=>n,bn:()=>s});var t=o(55245);let a={host:process.env.EMAIL_SERVER||"",port:parseInt(process.env.EMAIL_PORT||"587"),secure:465===parseInt(process.env.EMAIL_PORT||"587"),auth:{user:process.env.EMAIL_USER||"",pass:process.env.EMAIL_PASSWORD||""}},s=async(e,r)=>{let{orderId:o,buyOrder:t,courseTitles:a,totalAmount:s}=r,i=a.map(e=>`<li>${e}</li>`).join("");return n({to:e,subject:"Confirmaci\xf3n de compra - Coach Inostroza",html:`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h2 style="color: #333;">\xa1Gracias por tu compra!</h2>
      <p>Tu pago ha sido procesado correctamente. A continuaci\xf3n, encontrar\xe1s los detalles de tu compra:</p>
      
      <div style="background-color: #f4f4f4; padding: 15px; border-radius: 4px; margin: 20px 0;">
        <p><strong>N\xfamero de orden:</strong> ${o}</p>
        <p><strong>Referencia de pago:</strong> ${t}</p>
        <p><strong>Monto total:</strong> $${s.toFixed(2)}</p>
      </div>
      
      <h3 style="color: #333;">Cursos adquiridos:</h3>
      <ul>
        ${i}
      </ul>
      
      <p>Puedes acceder a tus cursos iniciando sesi\xf3n en nuestra plataforma.</p>
      
      <p>Si tienes alguna consulta, no dudes en contactarnos.</p>
      
      <p>Saludos,<br>El equipo de Coach Inostroza</p>
    </div>
  `})},n=async e=>{let r=t.createTransport(a);try{let o=await r.sendMail({from:process.env.EMAIL_FROM||'"Coach Inostroza" <no-reply@coachinostroza.com>',...e});return console.log(`Email sent: ${o.messageId}`),!0}catch(e){return console.error("Error sending email:",e),!1}}},85662:(e,r,o)=>{o.d(r,{OQ:()=>n,_I:()=>i});var t=o(31518);let a="https://uhdgxofdtybgcfjnahkp.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVoZGd4b2ZkdHliZ2Nmam5haGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4NzAyNjgsImV4cCI6MjA2MTQ0NjI2OH0.PgHnXDp1l7YB5zK7IEjSSEOM1yBjkvuEEDhUPHVTzM0";if(!a||!s)throw Error("Faltan las variables de entorno de Supabase. Aseg\xfarate de que NEXT_PUBLIC_SUPABASE_URL y NEXT_PUBLIC_SUPABASE_ANON_KEY est\xe9n definidas.");let n=(0,t.eI)(a,s,{auth:{persistSession:!0,autoRefreshToken:!0},global:{fetch:(...e)=>fetch(...e)}});async function i(e,r){let{error:o}=await n.storage.from(e).remove([r]);if(o)throw console.error("Error al eliminar archivo:",o),o;return!0}}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[948,972,518,545,245],()=>o(86275));module.exports=t})();